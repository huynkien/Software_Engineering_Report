\subsection{Quản lý tài liệu}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.95\textwidth]{graphics/SequenceDiagram/Library/Seq_diagram_Upload.png}
    \caption{Sơ đồ tuần tự cho use-case "Tải tài liệu lên hệ thống"}
    \label{fig:library_management_sequence_diagram}
\end{figure}

\textbf{Mô tả sơ đồ tuần tự "Tải tài liệu lên hệ thống":}
\begin{itemize}
    \item Người dùng (Sinh viên/Tutor) chọn file và nhập thông tin tài liệu, gửi yêu cầu lên Controller.
    \item Controller kiểm tra kích thước file, nếu lớn hơn 15MB thì trả về lỗi, nếu hợp lệ thì tiếp tục kiểm tra định dạng file.
    \item Nếu định dạng không hỗ trợ, trả về lỗi cho người dùng. Nếu hợp lệ, Controller yêu cầu Service lưu file và metadata.
    \item Service lưu metadata qua Repo xuống Database. Nếu lưu metadata lỗi, trả về lỗi cho người dùng.
    \item Nếu lưu metadata thành công, Service tiếp tục lưu file vào Storage. Nếu bộ nhớ đầy, hệ thống xóa metadata vừa lưu và báo lỗi bộ nhớ đầy cho người dùng.
    \item Nếu lưu file thành công, trả về thông báo thành công cho người dùng.
\end{itemize}

\subsection*{Mô tả: Tải tài liệu lên hệ thống}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{graphics/SequenceDiagram/Library/Seq_diagram_SearchView.png}
    \caption{Sơ đồ tuần tự cho use-case "Tìm kiếm và xem tài liệu"}
    \label{fig:library_management_sequence_diagram_2}
\end{figure}

\textbf{Mô tả sơ đồ tuần tự "Tìm kiếm và xem tài liệu":}
\begin{itemize}
    \item Người dùng gửi yêu cầu tìm kiếm tài liệu tới Controller, có thể kèm theo bộ lọc.
    \item Controller gọi Service để lấy danh sách metadata tài liệu phù hợp, Service truy vấn Repo và Database.
    \item Nếu truy vấn lỗi hoặc không tìm thấy tài liệu, trả về lỗi cho người dùng.
    \item Nếu tìm thấy, trả về danh sách tài liệu cho người dùng. Người dùng chọn tài liệu muốn xem.
    \item Controller kiểm tra quyền truy cập của người dùng với tài liệu đó.
    \item Nếu có quyền, hiển thị nút tải xuống; nếu không, ẩn nút tải xuống.
    \item Controller yêu cầu Service lấy file để xem trước, Service truy vấn Repo và Storage.
    \item Nếu file lỗi hoặc không tồn tại, trả về lỗi. Nếu thành công, trả về file xem trước cho người dùng.
\end{itemize}

\begin{figure}[H]
    \centering
    \includegraphics[width=1\textwidth]{graphics/SequenceDiagram/Library/Seq_diagram_Download.png}
    \caption{Sơ đồ tuần tự cho use-case "Tải tài liệu xuống hệ thống"}
    \label{fig:library_management_sequence_diagram_3}
\end{figure}

\textbf{Mô tả sơ đồ tuần tự "Tải tài liệu xuống hệ thống":}
\begin{itemize}
    \item Người dùng nhấn tải xuống tài liệu, Controller kiểm tra quyền truy cập.
    \item Nếu không có quyền, trả về thông báo lỗi.
    \item Nếu có quyền, Controller và Service thực hiện truy vấn file qua Repo và Database.
    \item Nếu truy vấn lỗi hoặc không tìm thấy file, trả về lỗi cho người dùng.
    \item Nếu tìm thấy, Service yêu cầu Repo tải file từ Storage.
    \item Nếu quá trình truyền file lỗi, trả về lỗi và cho phép người dùng thử lại.
    \item Nếu tải file thành công, trả về file cho người dùng.
\end{itemize}

\newpage

% @startuml
% actor       "Sinh viên/Tutor" as Actor
% participant     "Controller"     as Controller
% participant "ManageDocService"      as Service
% participant "ManageDocRepo"      as Repo
% participant "Storage"      as Collections
% database    "Database"        as DB

% Actor -> Controller ++: chooseFile(file)
% activate Actor
% Actor -> Controller: enter(title, course, permission)
% Controller -> Service ++ : checkSize(file)
% alt > 15 MB
%     Service --> Controller : bigFileSize
%     Controller --> Actor : bigFileSize
% else <= 15 MB
%     Controller -> Service  : checkFormat(file)
%     alt định dạng không hỗ trợ
%         Service --> Controller : errorFormat
%         Controller --> Actor : errorFormat
%     else định dạng hỗ trợ
%         Controller -> Service : saveFile(file, metadata, version)
%         Service -> Repo ++: saveMetadata(metadata, version)
%         Repo -> DB ++: saveMetadataRequest(metadata, version)
%         alt lỗi lưu metadata
%             DB --> Repo : errorSaveFile
%             Repo --> Service : errorSaveFile
%             Service --> Controller : errorSaveFile
%             Controller --> Actor : errorSaveFile
%         else không có lỗi lưu
%             DB --> Repo : successSaveMetadata
%             Repo --> Service : successSaveMetadata
%             Service --> Controller : successSaveMetadata
%             Service -> Repo : saveFile(file)
%             Repo -> Collections : saveFileRequest(file)
%             activate Collections
%              alt bộ nhớ đầy
%                 Collections --> Repo --: storageFull
%                 Repo --> Service : storageFull
%                 Service --> Controller : storageFull
%                 Service -> Repo : deleteMetadataAndVersion(metadata, version)
%                 Repo -> DB : deleteMetadataAndVersionRequest(metadata, version)
%                 DB --> Repo --: deleted
%                 Repo --> Service : deleted
%                 Service --> Controller : deleted
%                 Controller --> Actor : storageFull
%             else bộ nhớ còn trống
%                 Collections --> Repo --: successSaveFile
%                 Repo --> Service --: successSaveFile
%                 Service --> Controller --: successSaveFile
%                 Controller --> Actor --: successUpload
%                 deactivate Actor
%             end
%         end
%      end
%  end
% @enduml


% @startuml
% actor       "Sinh viên/Tutor" as Actor
% participant     "Controller"     as Controller
% participant "ManageDocService"      as Service
% participant "ManageDocRepo"      as Repo
% participant "Storage"      as Collections
% database    "Database"        as DB

% Actor -> Controller ++: findFile(tilename)
% activate Actor
% Actor -> Controller : filter(filterInterface, mode)
% Controller -> Service ++: getListMetadata(searchKey)
% Service -> Repo ++: getListMetadata(searchKey)
% Repo -> DB ++: queryListMetadataRequest(searchKey)
% alt lỗi truy xuất
%     DB --> Repo : failToQuery
%     Repo --> Service : failToQuery
%     Service --> Controller : failToQuery
%     Controller --> Actor : failToQuery
% else không có lỗi
%     alt không tìm thấy
%         DB --> Repo : failToSearch
%         Repo --> Service : failToSearch
%         Service --> Controller : failToSearch
%         Controller --> Actor : failToSearch
%     else tìm thấy
%         DB --> Repo --: listOfMetadata
%         deactivate DB
%         Repo --> Service : listOfMetadata
%         Service --> Controller : listOfMetadata
%         Controller --> Actor : listOfFileInterface
%         Actor -> Controller : chooseFileInterface(FileInterface)
%         Controller -> Service : checkPermission(fileMetadata)
%         Service --> Controller : permissionResult
%         alt có quyền tải xuống
%             Controller --> Actor : downloadButton
%         else không có quyền tải xuống
%             Controller --> Actor : noDownloadButton
%         end
%         Controller -> Service : getFile(fileInterface)
%         Service -> Repo : getFile(fileInterface)
%         Repo -> Collections ++: getFileRequest(fileInterface)
%         alt file lỗi/không tồn tại
%             Collections --> Repo : errorFile
%             Repo --> Service : errorFile
%             Service --> Controller : errorFile
%             Controller --> Actor : errorFile
%         else file có sẵn
%             Collections --> Repo --: filePreviewed
%             Repo --> Service --: filePreviewed
%             Service --> Controller --: filePreviewed
%             Controller --> Actor --: filePreviewed
%             deactivate Actor
%         end
%     end
% end
% @enduml



% @startuml
% actor       "Sinh viên/Tutor" as Actor
% participant     "Controller"     as Controller
% participant "ManageDocService"      as Service
% participant "ManageDocRepo"      as Repo
% participant "Storage"      as Collections
% database    "Database"        as DB

% Actor -> Controller ++: clickDownload(fileInterface)
% activate Actor
% Controller -> Service ++ : checkPermission(fileMetadata)
% alt không có quyền
%     Service --> Controller : notPermission
%     Controller --> Actor : notPermission
% else có quyền
%     loop actor vẫn muốn thử
%         Controller -> Service : searchFile(fileInterface)
%         Service -> Repo ++: searchFile(fileInterface)
%         Repo -> DB ++: queryFileRequest(fileInterface)
%         alt lỗi truy xuất
%             DB --> Repo : failToQuery
%             Repo --> Service : failToQuery
%             Service --> Controller : failToQuery
%             Controller --> Actor : failToQuery
%             Controller --> Actor : tryAgain
%             break actor thoát
%             end
%         else không có lỗi truy xuất
%             alt file không có
%                 DB --> Repo  : failToSearch
%                 Repo --> Service : failToSearch
%                 Service --> Controller : failToSearch
%                 Controller --> Actor : failToSearch
%                 break
%                 end
%             else tìm thấy file
%                 DB --> Repo --: successToSearch
%                 Repo --> Service : successToSearch
%                 Service -> Repo : downLoadFile(fileInterface, downLoadInfo)
%                 Repo -> Collections ++: downLoadFileRequest(fileInterface, downLoadInfo)
%                 alt lỗi truyền file
%                     Collections --> Repo : failToTransmmit
%                     Repo --> Service : failToTransmmit
%                     Service --> Controller : failToTransmmit
%                     Controller --> Actor : failToTransmmit
%                     Controller --> Actor : tryAgain
%                     break actor thoát
%                     end
%                 else không có lỗi truyền file
%                     Collections --> Repo --: fileDownloaded
%                     Repo --> Service --: fileDownloaded
%                     Service --> Controller --: fileDownloaded
%                     Controller --> Actor --: fileDownloaded
%                     deactivate Actor
%                     break
%                     end
%                 end
%             end
%         end
%     end
% end
% @enduml

